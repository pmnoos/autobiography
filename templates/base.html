{% load static %}
{% load i18n %}

<!DOCTYPE html>
<html lang="{{ current_language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Personal Autobiography App{% endblock %}</title>
    <link rel="icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">

    <!-- ✅ Google Fonts & W3.CSS -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">


    <!-- ✅ Lightbox2 CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css">

    <!-- ✅ Load TinyMCE v7 (Only One Instance with API Key) -->
    <script src="https://cdn.tiny.cloud/1/h1jz6d9xttu6bz1hsi7nyginwsxowh8nusj41k6bl6qj9o7z/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>

    <!-- ✅ Lightbox2 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>
</head>


<body class="w3-light-grey">

    <!-- Header Section -->
    <header class="site-header w3-blue-grey" style="background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); padding: 40px 20px; text-align: center;">
        <h1 class="title">{{ t.your_life_story }}</h1>
        <div style="width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; margin: 20px auto; display: flex; align-items: center; justify-content: center; font-size: 40px; color: white;">
            ✍️
        </div>
        <h2 class="subtitle">{{ t.subtitle }}</h2>
    </header>

    {% if messages %}
    <div class="w3-panel w3-blue-grey w3-display-container">
        <span onclick="this.parentElement.style.display='none'"
              class="w3-button w3-red w3-large w3-display-topright">x</span>
        {% for message in messages %}
            <p>{{ message }}</p>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Navigation Bar -->
    <nav class="w3-bar w3-white w3-border-bottom w3-padding">
        <div class="w3-bar-item w3-margin-left">
            <a href="{% url 'chapter_list' %}" class="w3-bar-item w3-margin-left w3-button w3-round-large w3-cyan">{{ t.home }}</a>
            <a href="{% url 'getting_started' %}" class="w3-bar-item w3-button w3-round-large w3-margin-left w3-indigo">{{ t.getting_started }}</a>
            <a href="{% url 'new_chapter' %}" class="w3-bar-item w3-button w3-round-large w3-margin-left w3-teal">{{ t.new_chapter }}</a>
            <a href="{% url 'gallery:gallery' %}" class="w3-bar-item w3-button w3-round-large w3-margin-left w3-yellow">{{ t.photo_gallery }}</a>
            {% if user.is_authenticated %}
                <a href="{% url 'gallery:upload_image' %}" class="w3-bar-item w3-button w3-round-large w3-margin-left w3-orange">{{ t.upload_images }}</a>
            {% endif %}
            {% if user.is_staff %}
                <a href="{% url 'admin:index' %}" class="w3-bar-item w3-button w3-round-large w3-margin-left w3-purple">{{ t.admin_panel }}</a>
                <a href="{% url 'export_chapters' %}" class="w3-bar-item w3-button w3-round-large w3-margin-left w3-green">{{ t.download_backup }}</a>
            {% endif %}
        </div>
        
        <!-- Language Selector -->
        <div class="w3-dropdown-hover w3-right">
            <button class="w3-button w3-round-large w3-margin-right w3-light-grey">
                🌍 {{ current_language|upper }}
            </button>
            <div class="w3-dropdown-content w3-bar-block w3-card-4">
                <form name="setLangForm" action="{% url 'set_language' %}" method="POST" style="display: inline;">
                    {% csrf_token %}
                    <input name="next" type="hidden" value="{{ request.path }}">
                    <a href="#" onclick="setLanguage('en')" class="w3-bar-item w3-button">🇺🇸 English</a>
                    <a href="#" onclick="setLanguage('es')" class="w3-bar-item w3-button">🇪🇸 Español</a>
                    <a href="#" onclick="setLanguage('fr')" class="w3-bar-item w3-button">🇫🇷 Français</a>
                </form>
            </div>
        </div>
        
        {% if user.is_authenticated %}
            <a href="{% url 'logout' %}" class="w3-button w3-red w3-round w3-right">{{ t.logout }}</a>
            <span class="w3-right w3-margin-right">{{ t.welcome }}, {{ user.username }}!</span>
        {% else %}
            <a href="{% url 'login' %}" class="w3-button w3-blue w3-round w3-right">{{ t.login }}</a>
        {% endif %}
    </nav>

    <!-- Page Content -->
    <div class="w3-container w3-padding content-container w3-blue-grey w3-round-large w3-margin-top">
        {% block content %}
        {% endblock %}
    </div>

    <hr>

    <!-- Footer -->
    <footer class="w3-container w3-blue-grey w3-center w3-margin-top">
        <div class="w3-padding">
            <!-- Quote -->
            <p class="w3-medium w3-margin-top w3-opacity" style="margin-top: 12px; text-align: center;">
                <em>"{{ t.footer_quote }}"</em>
            </p>
            
            <!-- Decorative Line -->
            <hr style="width:60%; margin: 10px auto; border:1px solid #ccc; opacity:0.3;">
            
            <!-- Signature -->
            <p class="w3-medium w3-opacity" style="text-align: center;">
                <em>{{ t.footer_signature }}</em>
            </p>
        </div>
    </footer>

    <!-- ✅ W3.CSS JavaScript for Responsive Navigation -->
    <script>
        function toggleNav() {
            var nav = document.getElementById("mySidenav");
            if (nav.style.display === "block") {
                nav.style.display = "none";
            } else {
                nav.style.display = "block";
            }
        }
    </script>
  <!-- ✅ TinyMCE Initialization (Ensures it Loads Correctly) -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        if (typeof tinymce !== "undefined") {
            tinymce.init({
                selector: 'textarea',
                plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount',
                toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table | align lineheight | numlist bullist indent outdent | emoticons charmap | removeformat',
                automatic_uploads: true
            });
            console.log("✅ TinyMCE v7 initialized successfully.");
        } else {
            console.error("❌ TinyMCE failed to load. Check the API key or script URL.");
        }
    });
</script>

<!-- ✅ Lightbox Initialization for Chapter Images -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".chapter-content img").forEach(img => {
            if (!img.parentElement.hasAttribute("data-lightbox")) {
                let link = document.createElement("a");
                link.href = img.src;
                link.setAttribute("data-lightbox", "gallery");
                img.parentNode.insertBefore(link, img);
                link.appendChild(img);
            }
        });
        console.log("✅ Lightbox applied to images.");
    });

</script>
<!-- Toast Message Container -->
<div id="toast" class="w3-hide w3-green w3-padding w3-round-large w3-animate-opacity" 
     style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
    ✅ Backup download started!
</div>
<!-- Toast Trigger for Backup Button -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const backupLink = document.querySelector('a[href$="export_chapters/"]');
        const toast = document.getElementById("toast");

        if (backupLink && toast) {
            backupLink.addEventListener("click", () => {
                toast.classList.remove("w3-hide");
                setTimeout(() => {
                    toast.classList.add("w3-hide");
                }, 3000); // Toast visible for 3 seconds
            });
        }
    });
</script>

<script>
    function setLanguage(langCode) {
        var form = document.forms['setLangForm'];
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'language';
        input.value = langCode;
        form.appendChild(input);
        form.submit();
    }
</script>
</body>
</html> 